@using Bakim.Entity.Views;

@model TaskViewModel

 
<div class="container">
    <div class="row">
        <div class="col-md-6 col-lg-6 col-xl-6 col-xxl-3 mb-md-5 mb-xl-10">
            <div class="card bg-primary hoverable h-100">
                <div class="card-header border-0">
                        <span class="svg-icon svg-icon-white svg-icon-4x mt-3"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path opacity="0.3" d="M18.4 5.59998C21.9 9.09998 21.9 14.8 18.4 18.3C14.9 21.8 9.2 21.8 5.7 18.3L18.4 5.59998Z" fill="currentColor"/>
                        <path d="M12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C17.5 22 22 17.5 22 12C22 6.5 17.5 2 12 2ZM19.9 11H13V8.8999C14.9 8.6999 16.7 8.00005 18.1 6.80005C19.1 8.00005 19.7 9.4 19.9 11ZM11 19.8999C9.7 19.6999 8.39999 19.2 7.39999 18.5C8.49999 17.7 9.7 17.2001 11 17.1001V19.8999ZM5.89999 6.90002C7.39999 8.10002 9.2 8.8 11 9V11.1001H4.10001C4.30001 9.4001 4.89999 8.00002 5.89999 6.90002ZM7.39999 5.5C8.49999 4.7 9.7 4.19998 11 4.09998V7C9.7 6.8 8.39999 6.3 7.39999 5.5ZM13 17.1001C14.3 17.3001 15.6 17.8 16.6 18.5C15.5 19.3 14.3 19.7999 13 19.8999V17.1001ZM13 4.09998C14.3 4.29998 15.6 4.8 16.6 5.5C15.5 6.3 14.3 6.80002 13 6.90002V4.09998ZM4.10001 13H11V15.1001C9.1 15.3001 7.29999 16 5.89999 17.2C4.89999 16 4.30001 14.6 4.10001 13ZM18.1 17.1001C16.6 15.9001 14.8 15.2 13 15V12.8999H19.9C19.7 14.5999 19.1 16.0001 18.1 17.1001Z" fill="currentColor"/>
                        </svg>
                        </span>
                            <div class="fw-bold text-white d-flex fs-3"><h1 class="fs-3x" style="color:white">@Model.WorkTasks.Where(c=>c.CreatedDate.Day == DateTime.Now.Day && c.CreatedDate.Month == DateTime.Now.Month && c.CreatedDate.Year == DateTime.Now.Year).Count()</h1></div>
                </div> 
                <div class="card-body pt-0">
                    <div class="text-white fw-bolder fs-2">Toplam Kayıt</div>
                    <div class="fw-bold text-white">Bu gün içerisindeki Toplam Kayıt</div>
                </div>
            </div>
        </div> 
        <div class="col-md-6 col-lg-6 col-xl-6 col-xxl-3 mb-md-5 mb-xl-10">
            <div  class="card bg-warning hoverable h-100">
                <div class="card-header border-0">
                        <span class="svg-icon svg-icon-white svg-icon-4x mt-3"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path opacity="0.3" d="M12 22C13.6569 22 15 20.6569 15 19C15 17.3431 13.6569 16 12 16C10.3431 16 9 17.3431 9 19C9 20.6569 10.3431 22 12 22Z" fill="currentColor"/>
                        <path d="M19 15V18C19 18.6 18.6 19 18 19H6C5.4 19 5 18.6 5 18V15C6.1 15 7 14.1 7 13V10C7 7.6 8.7 5.6 11 5.1V3C11 2.4 11.4 2 12 2C12.6 2 13 2.4 13 3V5.1C15.3 5.6 17 7.6 17 10V13C17 14.1 17.9 15 19 15ZM11 10C11 9.4 11.4 9 12 9C12.6 9 13 8.6 13 8C13 7.4 12.6 7 12 7C10.3 7 9 8.3 9 10C9 10.6 9.4 11 10 11C10.6 11 11 10.6 11 10Z" fill="currentColor"/>
                        </svg>
                        </span>
                    <div class="fw-bold text-white d-flex fs-3"><h1 class="fs-3x" style="color:white">@Model.WorkTasks.Where(m=>m.IsCompleted == false).Count()</h1></div>
                </div>
                <div class="card-body pt-0">
                    <div class="text-white fw-bolder fs-2">Açık Kayıtlar</div>
                    <div class="fw-bold text-white">Henüz Kapatılmamış Kayıtlar</div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-6 col-xl-6 col-xxl-3 mb-md-5 mb-xl-10">
            <div  class="card bg-success hoverable h-100">
                <div class="card-header border-0">
                         <span class="svg-icon svg-icon-white svg-icon-4x mt-3"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path opacity="0.3" d="M12.9 10.7L3 5V19L12.9 13.3C13.9 12.7 13.9 11.3 12.9 10.7Z" fill="currentColor"/>
                        <path d="M21 10.7L11.1 5V19L21 13.3C22 12.7 22 11.3 21 10.7Z" fill="currentColor"/>
                        </svg>
                        </span>
                     <div class="fw-bold text-white d-flex fs-3"><h1 class="fs-3x" style="color:white">@Model.WorkTasks.Where(m=>m.InProcess == true).Count()</h1></div>
                </div>
                <div class="card-body pt-0">
                    <div class="text-white fw-bolder fs-2">Devam Eden Kayıtlar</div>
                    <div class="fw-bold text-white">İşlemde olan iş emirleri</div>
                </div>  
            </div> 
        </div>
        <div class="col-md-6 col-lg-6 col-xl-6 col-xxl-3 mb-md-5 mb-xl-10">
            <div  class="card bg-danger hoverable h-100">
                <div class="card-header border-0">
                        <span class="svg-icon svg-icon-white svg-icon-4x mt-3"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M6.28548 15.0861C7.34369 13.1814 9.35142 12 11.5304 12H12.4696C14.6486 12 16.6563 13.1814 17.7145 15.0861L19.3493 18.0287C20.0899 19.3618 19.1259 21 17.601 21H6.39903C4.87406 21 3.91012 19.3618 4.65071 18.0287L6.28548 15.0861Z" fill="currentColor"/>
                        <rect opacity="0.3" x="8" y="3" width="8" height="8" rx="4" fill="currentColor"/>
                        </svg>
                        </span>
                      <div class="fw-bold text-white d-flex fs-3"><h1 class="fs-3x" style="color:white">@Model.WorkTasks.Where(m=>m.Receiver ==  Model.User && m.IsCompleted == false).Count()</h1></div>
                </div>
                <div class="card-body pt-0">
                    <div class="text-white fw-bolder fs-2">Bana Özel İş Emirleri</div>
                    <div class="fw-bold text-white">Size özel iş emirleri</div>
                </div>
            </div>
        </div>
    </div>
   
    <div class="card card-flush shadow-sm">
        <div class="card-header">
            <h3 class="card-title">İş Emirleri</h3>
            <div class="card-toolbar">
                    <div class="d-flex justify-content-end mt-3"><a asp-controller="Worktasks" asp-action="AddTask" class="btn bg-primary btn-active-light-secondary text-white"><i class="fa fa-plus" style="color: white" aria-hidden="true"></i> Yeni İş Emri Oluştur</a></div>
            </div>
        </div>
        <div class="card-body py-5">
            @(Html.DevExtreme().DataGrid<atanankullanicilar>()
            
            .ID("taleplistesi")
            .ShowBorders(true)
            .DataSource(d => d.Mvc().LoadAction("WorkTaskTable").Controller("WorkTasks"))
            .FilterRow(filterRow => filterRow
            .Visible(true)
            .ApplyFilter(GridApplyFilterMode.Auto)
            )
            .Height("100%")
            .SearchPanel(searchPanel => searchPanel.Visible(true).Width(300))
            


        .Toolbar(toolbar => {

                toolbar.Items(items => {

                    items.Add()

                        .Name("exportButton");

                     items.Add()
                    
                        .Widget(w=>w
                        .Button()
                        .Visible(true)
                        .Icon("filter")
                        .Text("Bana özel")
                        .OnClick("filterbutton")
                        .OnInitialized("initFilterButton")
                        .ID("filterButton")
                    );       
                                     
                    items.Add()
                    
                        .Name("searchPanel");  
                });
            })

            .Paging(paging => paging.PageSize(10))
            .Pager(p=>
            p.AllowedPageSizes(new JS("[5, 10, 20]"))
            .ShowNavigationButtons(true)
            .ShowPageSizeSelector(true)
            .Visible(true)
            .ShowNavigationButtons(true)
            .ShowInfo(true)
            .DisplayMode(GridPagerDisplayMode.Full)
            )
            .KeyExpr("TaskId")
            
            .Columns(columns => {
                @* columns.AddFor(m => m.ImagePath).CellTemplate(@<text>
                    <div>
                    <img style="max-width:100%; height:auto;" src="/app/images/worktasks/<%- data.ImagePath %>" alt="" />
                    </div>
                    </text>).Caption("IsEmri Resmi"); *@

            columns.AddFor(m => m.TaskTitle).Caption("Is Emri").Alignment(HorizontalAlignment.Left).Width(250).AllowExporting(false);

            columns.AddFor(m=> m.TaskDescription).Caption("Aciklama").Alignment(HorizontalAlignment.Center);

            columns.AddFor(m => m.CreatedDate).SortOrder(SortOrder.Desc).Caption("Olusturma Tarihi").Alignment(HorizontalAlignment.Center).Width(200);

            columns.AddFor(m=>m.Durum).Alignment(HorizontalAlignment.Center).AllowExporting(false).Caption("Durum").Width(100).AllowEditing(false).AllowFiltering(false).AllowSearch(false).CellTemplate(@<text>

                <span class="badge badge-lg <%- data.Durum == 'Normal' ? 'badge-light' : 'badge-danger' %>"><%- data.Durum %></span>
            </text>);

            columns.AddFor(m=>m.ReceiverId).Lookup(l=>l.DataSource(d=>d.Mvc().LoadAction("usergetir").Key("Id")).DisplayExpr("UserName").ValueExpr("Id")).Caption("Kullanici").Alignment(HorizontalAlignment.Center);

            columns.AddFor(m=>m.İlerleme).Alignment(HorizontalAlignment.Center).Caption("Ilerleme").AllowEditing(false).AllowFiltering(true).AllowSearch(true);

            columns.AddFor(m=>m.TaskId).AllowExporting(false).Alignment(HorizontalAlignment.Center).Caption("").AllowEditing(false).AllowFiltering(false).AllowSearch(false).CellTemplate(new JS("detailbutton")); 

            })
                .Selection(s=> s.Mode(SelectionMode.Multiple))
                .Export(e=> e.Enabled(true)
                .AllowExportSelectedData(true)
                
                )
                .OnExporting("selectExport") 
            ) 
        </div>
        <div class="card-footer">
        </div>    
    </div>
</div>

<script>

    function detailbutton(container, options)
    {
        if(options.data.IsActive == true && options.data.InProcess == false && options.data.IsCompleted == false)
        {
            $('<a href="/Worktasks/StartTask?id=' + options.data.TaskId + '"  class="btn btn-icon btn-primary ms-4">\
                    <span class="svg-icon svg-icon-muted svg-icon-2hx"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect opacity="0.3" x="2" y="2" width="20" height="20" rx="10" fill="currentColor"/>\
                    <rect x="11" y="17" width="7" height="2" rx="1" transform="rotate(-90 11 17)" fill="currentColor"/><rect x="11" y="9" width="2" height="2" rx="1" transform="rotate(-90 11 9)" fill="currentColor"/></svg></span>\
                </a>').appendTo(container);
        }

         if(options.data.IsActive == true && options.data.InProcess ==  true && options.data.IsCompleted == false)
        {
            $('<a href="/WorkTasks/EndTask?id=' + options.data.TaskId + '" class="btn btn-icon btn-warning ms-4" >\
                    <span class="svg-icon svg-icon-muted svg-icon-2hx"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect opacity="0.3" x="2" y="2" width="20" height="20" rx="10" fill="currentColor"/>\
                    <rect x="11" y="17" width="7" height="2" rx="1" transform="rotate(-90 11 17)" fill="currentColor"/><rect x="11" y="9" width="2" height="2" rx="1" transform="rotate(-90 11 9)" fill="currentColor"/></svg></span>\
                </a>').appendTo(container);
        }

        if(options.data.IsActive == false && options.data.InProcess ==  false && options.data.IsCompleted == true)
        {
            $('<a href="/WorkTasks/TaskDetails?id=' + options.data.TaskId + '" class="btn btn-icon btn-success ms-4">\
                    <span class="svg-icon svg-icon-muted svg-icon-2hx"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect opacity="0.3" x="2" y="2" width="20" height="20" rx="10" fill="currentColor"/>\
                    <rect x="11" y="17" width="7" height="2" rx="1" transform="rotate(-90 11 17)" fill="currentColor"/><rect x="11" y="9" width="2" height="2" rx="1" transform="rotate(-90 11 9)" fill="currentColor"/></svg></span>\
                </a>').appendTo(container);
        }
    }

  
    function selectExport(e){
         Swal.fire({
        text: "Format Seçiniz",
        icon: "success",
        buttonsStyling: false,
        confirmButtonText: "PDF Olarak Çıkar",
        cancelButtonText:"Excel Olarak Çıkar",
        showCancelButton : true,
        customClass: {
            confirmButton: "btn btn-danger",
            cancelButton: "btn btn-success"
        }
        }).then(function(result){
            if(result.isConfirmed){
                exportToPDF(e);
                console.log(result);
            }
            else if(result.dismiss == "cancel"){
                exporting(e);
            }
                console.log(result);
        });
    }

     function exportToPDF(e) {
        var doc = new jsPDF();

        DevExpress.pdfExporter.exportDataGrid({
            jsPDFDocument: doc,
            component: e.component,
            indent: 5,
        }).then(function () {
            doc.save("IsEmri @DateTime.Now .pdf");
        });
    }

    function exporting(e) 
    {
        var workbook = new ExcelJS.Workbook();
        var worksheet = workbook.addWorksheet('IsEmirleri');

        DevExpress.excelExporter.exportDataGrid({
            component: e.component,
            worksheet: worksheet,
            autoFilterEnabled: true
        }).then(function () {
            workbook.xlsx.writeBuffer().then(function (buffer) {
                saveAs(new Blob([buffer], { type: 'application/octet-stream' }), 'IsEmri.xlsx');
            });
        });
        e.cancel = true;
    }

    let isFilterApplied = false;

    function filterbutton(button)
    {
        let element = document.getElementById("taleplistesi");
        let instance = DevExpress.ui.dxDataGrid.getInstance(element);

        if (isFilterApplied) {
            instance.clearFilter();
            isFilterApplied = false;
            button.option("text", "Bana özel");
        } else {
            instance.filter(['ReceiverId', '=', "@Model.User.Id"]);
            isFilterApplied = true;
            button.option("text", "Tümü");
        }

        isFilterApplied = instance.filter().length > 0;

        // Tümü butonuna tıklandığında mevcut filtreyi temizle
        if (!isFilterApplied) {
            showAllData();
        } else {
            instance.filter(['ReceiverId', '=', "@Model.User.Id"]);
        }
    }

    function showAllData() 
    {
        let element = document.getElementById("taleplistesi");
        let instance = DevExpress.ui.dxDataGrid.getInstance(element);

        // Filtreyi temizle
        instance.clearFilter();

        // Tümü butonunu Bana Özel olarak değiştir
        let filterButton = instance.getToolbar().getItemWidget("filterButton");
        filterButton.option("text", "Bana Özel");

        // Filtrenin uygulandığını belirtmek için isFilterApplied değişkenini güncelle
        isFilterApplied = false;
        }

        function initFilterButton(e) 
        {
        let filterButton = e.component;
        filterButton.showAllData = showAllData;
        filterButton.option("onClick", function() {
            filterbutton(filterButton);
        });
    }

    // Tümü butonuna ait özellikleri tanımlamak için initFilterButton fonksiyonunu çağır
    initFilterButton({
        component: DevExpress.ui.dxButton.getInstance(document.getElementById("filterButton"))
    });

</script>


